<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head lang="en">
    <meta charset="UTF-8">
    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static 'template.css' %}">
    <title>Dashboard</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script>
// Move to its own file later
$(document).ready(function() {
      connect();

      function connect(){
          var socket;
          var host = "ws://localhost:1025/ws";

          try{
              var socket = new WebSocket(host);

              message('<p class="event">Connecting... ');

              socket.onopen = function(){
                 message('<p class="event">Connected!');
              }

              socket.onmessage = function(msg){
                    console.log("Msg: " + msg.data)
                 var msgcomponents = msg.data.split("::");
                 var topicname = msgcomponents[1];
                 message('<p class="message">' + msgcomponents[0], topicname);
              }

              socket.onclose = function(){
                message('<p class="event">Lost connection.');
              }

          } catch(exception){
             message('<p>Error'+exception);
          }

          function send(topicname, text){
              var testusername = "{{ user }}"
              var dashboardname = "{{ dashboard.title }}"
              var text = dashboardname + "::" + testusername + "::" + text + "::" + topicname

              if(text==""){
                  message('<p class="warning">Please enter a message');
                  return ;
              }
              try{
                  socket.send(text);
                  //message('<p class="event">Sent: '+text)

              } catch(exception){
                 message('<p class="warning">');
              }
          }

          function message(msg, topicname){
            $('.'+ topicname + ' > #chatLog').append(msg+'</p>');
          }

          $('.textbox').keypress(function(event) {
              if (event.keyCode == '13') {
                var id = $(event.target).attr("id")// get attribute for the textbox pressed
                var text = $(event.target).val()
                send(id, text);
                $(event.target).val("");
              }
          });

          $('#disconnect').click(function(){
             socket.close();
          });

      }//End connect
});

    </script>
</head>
<body>
	{% include "header.html"%}
	<div class="cdbody">
		<h1>You found {{ dashboard.title }}</h1>
        <div class="topic1">
            Topic1
		<div id="chatLog">
        {% for message in all_messages_1 %}
			<p class="message">{{ message.msgtext }}
		{% endfor %}
		</div>
        </div>
        <input class="textbox" id="topic1" type="text" name="message" placeholder="Message">

        <div class="topic2">
            Topic2
		<div id="chatLog">
        {% for message in all_messages_2 %}
			<p class="message">{{ message.msgtext }}
		{% endfor %}
		</div>
        </div>
		<input class="textbox" id="topic2" type="text" name="message" placeholder="Message">
	</div>
<p>
    <a href="/DashboardPermissions/?dashboard={{dashboard.title}}">Edit Dashboard Users</a>
	{% include "footer.html"%}
</body>
</html>