<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head lang="en">
    <meta charset="UTF-8">
    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static 'template.css' %}">
    <title>Dashboard</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script>
// Move to its own file later
$(document).ready(function() {
      connect();

      function connect(){
          var socket;
          var host = "ws://localhost:1025/ws";

          try{
              var socket = new WebSocket(host);

              displayMessage('<p class="event">Connecting... ');

              socket.onopen = function(){
                 displayMessage('<p class="event">Connected!');
              }

              socket.onmessage = function(msg){
                 //console.log("Msg: " + msg.data)
                 var msgcomponents = msg.data.split("::");
                 var dashTemp = String(msgcomponents[0]);
                 var dashboard = dashTemp.split("\)>")[1];
                 var topicname = msgcomponents[1];
                 var username = msgcomponents[2];
                 var userMessage = msgcomponents[3];
                 console.log("dash from msg is "+ dashboard)
                 var stringToDisplay = '<p class="message">' + username + ': ' + userMessage;
                 var dashTitle = String("{{dashboard.title}}")
                 if(dashboard.trim() == dashTitle.trim()) {
                    displayMessage(stringToDisplay, topicname);
                 }
              }

              socket.onclose = function(){
                 displayMessage('<p class="event">Lost connection.');
              }

          } catch(exception){
             displayMessage('<p>Error'+exception);
          }

          function send(topicname, text){
              var username = "{{ user }}"
              var dashboardname = "{{ dashboard.title }}"
              var textToSend = dashboardname + "::" + topicname + "::" + username + "::" + text

              if(text==""){
                  displayMessage('<p class="warning">Please enter a message');
                  return ;
              }
              try{
                  socket.send(textToSend);
              } catch(exception){
                 displayMessage('<p class="warning">');
              }
          }

          function displayMessage(msg, topicname){
            $('.'+ topicname + ' > #chatLog').append(msg+'</p>');
          }

          $('.textbox').keypress(function(event) {
              if (event.keyCode == '13') {
                var id = $(event.target).attr("id")// get attribute for the textbox pressed
                var text = $(event.target).val()
                send(id, text);
                $(event.target).val("");
              }
          });

          $('#disconnect').click(function(){
             socket.close();
          });

      }//End connect
});

          function addTopicWindow(topicWindowName) {
            var topicWindowString = '<div class="' + topicWindowName + '">' + topicWindowName +
            '<div id="chatLog"></div> </div><input class="textbox" id="' + topicWindowName + '" type="text" name="message" placeholder="Message">';

            $('.cdbody').append(topicWindowString);
          }

    </script>
</head>
<body>
	{% include "header.html"%}
	<div class="cdbody">
		<h1>You found {{ dashboard.title }}</h1>
        <div class="topic1">
            Topic1
		<div id="chatLog">
        <!--{% for message in all_messages_1 %}
			<p class="message">{{ message.msgtext }}
		{% endfor %}-->
		</div>
        </div>
        <input class="textbox" id="topic1" type="text" name="message" placeholder="Message">

        <div class="topic2">
            Topic2
		<div id="chatLog">
        <!--{% for message in all_messages_2 %}
			<p class="message">{{ message.msgtext }}
		{% endfor %}-->
		</div>
        </div>
		<input class="textbox" id="topic2" type="text" name="message" placeholder="Message">
	</div>
<p>
<<<<<<< HEAD
    <a href="javascript:addTopicWindow('New Topic Window')">Add Topic Window</a><br />
    <a href="/DashboardPermissions/?dashboard={{dashboard.title}}">Edit Dashboard Users</a>
=======
    <a href="/DashboardPermissions/?dashboard={{dashboard.title}}">Edit Dashboard Users</a><br />

>>>>>>> origin/master
	{% include "footer.html"%}
</body>
</html>